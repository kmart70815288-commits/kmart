<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin - ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช ูุงูุนุฑูุถ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; }
  .prod-img { width: 100%; max-width: 80px; height: auto; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
  .img-container { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; }
  .table td { vertical-align: middle; }
</style>
</head>
<body>
<div class="container py-5">
  <h2 class="mb-4">ููุญุฉ ุชุญูู ุงูุฃุฏูู</h2>

  <!-- ุชุณุฌูู ุงูุฏุฎูู -->
  <div id="loginDiv" class="mb-4">
    <input type="password" id="adminPass" class="form-control mb-2" placeholder="ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุงูุฃุฏูู">
    <button id="loginBtn" class="btn btn-primary">ุฏุฎูู</button>
    <div id="loginMsg" class="text-danger mt-2"></div>
  </div>

  <!-- ููุญุฉ ุงูุชุญูู -->
  <div id="adminPanel" class="d-none">

    <!-- ๐น ุงูููุชุฌุงุช -->
    <h3 class="mb-3">ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</h3>

    <!-- ุชุตุฏูุฑ ูุงุณุชูุฑุงุฏ -->
    <div class="mb-4">
      <button id="exportBtn" class="btn btn-info me-2">ุชุตุฏูุฑ ุงูููุชุฌุงุช</button>
      <input type="file" id="importFile" accept=".json" class="form-control d-inline-block" style="width:auto">
      <button id="importBtn" class="btn btn-success">ุงุณุชูุฑุงุฏ ุงูููุชุฌุงุช</button>
      <div id="importMsg" class="mt-2"></div>
    </div>

    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูุจุงุฑููุฏ">
    </div>

    <div class="card mb-4 p-3">
      <h5>ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</h5>
      <form id="addForm" class="row g-2">
        <div class="col-md-2"><input name="name" class="form-control" placeholder="ุงุณู ุงูููุชุฌ" required></div>
        <div class="col-md-2"><input name="price" type="number" class="form-control" placeholder="ุงูุณุนุฑ" required></div>
        <div class="col-md-2"><input name="quantity" type="number" class="form-control" placeholder="ุงููููุฉ ุงููุชููุฑุฉ" required></div>
        <div class="col-md-2"><input name="category" class="form-control" placeholder="ุงููุณู"></div>
        <div class="col-md-2"><input name="img" type="file" accept="image/*" class="form-control"></div>
        <div class="col-md-2"><input name="barcode" class="form-control" placeholder="ุงูุจุงุฑููุฏ"></div>
        <div class="col-12"><label><input type="checkbox" name="isWeightBased"> ุจูุน ุจุงููุฒู</label></div>
        <div class="col-12"><button class="btn btn-success mt-2">ุฅุถุงูุฉ ุงูููุชุฌ</button></div>
      </form>
      <div id="addMsg" class="mt-2"></div>
    </div>

    <div class="table-responsive mb-5">
      <table class="table table-bordered bg-white" id="productsTable">
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>ุงูุงุณู</th>
            <th style="width:100px">ุงูุณุนุฑ</th>
            <th style="width:100px">ุงููููุฉ</th>
            <th>ุงููุณู</th>
            <th style="width:90px">ุตูุฑุฉ</th>
            <th style="width:80px">ุจุงุฑููุฏ</th>
            <th style="width:120px">ุจูุน ุจุงููุฒู</th>
            <th style="width:150px">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ๐น ุงูุนุฑูุถ -->
    <h3 class="mb-3">ุฅุฏุงุฑุฉ ุงูุนุฑูุถ</h3>

    <div class="card mb-4 p-3">
      <h5>ุฅุถุงูุฉ ุนุฑุถ ุฌุฏูุฏ</h5>
      <form id="addOfferForm" class="row g-2">
        <div class="col-md-3"><input name="title" class="form-control" placeholder="ุนููุงู ุงูุนุฑุถ" required></div>
        <div class="col-md-4"><input name="desc" class="form-control" placeholder="ูุตู ุงูุนุฑุถ"></div>
        <div class="col-md-3"><input name="img" type="file" accept="image/*" class="form-control"></div>
        <div class="col-12"><button class="btn btn-success mt-2">ุฅุถุงูุฉ ุงูุนุฑุถ</button></div>
      </form>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered bg-white" id="offersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>ุงูุนููุงู</th>
            <th>ุงููุตู</th>
            <th>ุงูุตูุฑุฉ</th>
            <th>ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<script>
const API_ADMIN = '/api/admin/products';
const API_PUBLIC = '/api/products';
const API_LOGIN = '/api/admin/login';
const API_OFFERS = '/api/offers';
const API_ADMIN_OFFERS = '/api/admin/offers';

let TOKEN = '';
let allProducts = [];
let filteredProducts = [];
const PLACEHOLDER_IMG = '/frontend/img/placeholder.png';

// ๐น ุชุณุฌูู ุงูุฏุฎูู
document.getElementById('loginBtn').onclick = async () => {
  const pass = document.getElementById('adminPass').value;
  try {
    const res = await fetch(API_LOGIN, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ password: pass })
    });
    const json = await res.json();
    if(json.ok){
      TOKEN = json.token;
      document.getElementById('loginDiv').classList.add('d-none');
      document.getElementById('adminPanel').classList.remove('d-none');
      loadProducts();
      loadOffers();
    } else {
      document.getElementById('loginMsg').textContent = json.msg || 'ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู';
    }
  } catch(err){ console.error(err); }
};

// ========================== ุงูููุชุฌุงุช ==========================
async function loadProducts(){
  try{
    const res = await fetch(API_PUBLIC);
    const data = await res.json();
    allProducts = Array.isArray(data) ? data : [];
    filteredProducts = allProducts;
    renderTable();
  }catch(err){ console.error(err); }
}

function renderTable(){
  const tbody = document.querySelector('#productsTable tbody');
  tbody.innerHTML = '';
  filteredProducts.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td><input class="form-control form-control-sm" value="${p.name||''}" id="name${p.id}"></td>
      <td><input class="form-control form-control-sm" type="number" value="${p.price||0}" id="price${p.id}"></td>
      <td><input class="form-control form-control-sm" type="number" value="${p.quantity||0}" id="qty${p.id}"></td>
      <td><input class="form-control form-control-sm" value="${p.category||''}" id="cat${p.id}"></td>
      <td class="img-container">
        <img src="${p.img||PLACEHOLDER_IMG}" class="prod-img mb-1" id="imgDisplay${p.id}">
        <input type="file" accept="image/*" class="form-control form-control-sm" id="imgFile${p.id}">
      </td>
      <td><input class="form-control form-control-sm" value="${p.barcode||''}" id="barcode${p.id}"></td>
      <td><input type="checkbox" ${p.isWeightBased?'checked':''} id="isWeightBased${p.id}"></td>
      <td>
        <button class="btn btn-sm btn-primary mb-1" onclick="updateProduct('${p.id}')">ุชุนุฏูู</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">ุญุฐู</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ุฅุถุงูุฉ ููุชุฌ
document.getElementById('addForm').onsubmit = async (e)=>{
  e.preventDefault();
  const formData = new FormData(e.target);
  formData.append('isWeightBased', e.target.isWeightBased.checked);
  try{
    const res = await fetch(API_ADMIN,{
      method:'POST',
      headers:{ 'Authorization':'Bearer '+TOKEN },
      body: formData
    });
    const json = await res.json();
    if(json.ok){
      e.target.reset();
      loadProducts();
    } else alert('ูุดู ุงูุฅุถุงูุฉ');
  }catch(err){ console.error(err); alert('ุฎุทุฃ ูู ุงูุงุชุตุงู'); }
};

// ุชุนุฏูู ุงูููุชุฌุงุช
async function updateProduct(id){
  const formData = new FormData();
  formData.append('name', document.getElementById(`name${id}`).value.trim());
  formData.append('price', document.getElementById(`price${id}`).value.trim());
  formData.append('quantity', document.getElementById(`qty${id}`).value.trim());
  formData.append('category', document.getElementById(`cat${id}`).value.trim());
  formData.append('barcode', document.getElementById(`barcode${id}`).value.trim());
  formData.append('isWeightBased', document.getElementById(`isWeightBased${id}`).checked);
  const imgFile = document.getElementById(`imgFile${id}`).files[0];
  if(imgFile) formData.append('img', imgFile);
  const res = await fetch(`${API_ADMIN}/${id}`,{
    method:'PUT',
    headers:{ 'Authorization':'Bearer '+TOKEN },
    body: formData
  });
  const json = await res.json();
  if(json.ok) loadProducts();
  else alert('ูุดู ุงูุชุนุฏูู');
}

// ุญุฐู ุงูููุชุฌุงุช
async function deleteProduct(id){
  if(!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูููุชุฌุ')) return;
  const res = await fetch(`${API_ADMIN}/${id}`,{
    method:'DELETE',
    headers:{ 'Authorization':'Bearer '+TOKEN }
  });
  const json = await res.json();
  if(json.ok) loadProducts();
  else alert('ูุดู ุงูุญุฐู');
}

// ุงูุจุญุซ
document.getElementById('searchInput').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  filteredProducts = allProducts.filter(p=>
    (p.name||'').toLowerCase().includes(q) ||
    (p.barcode||'').toLowerCase().includes(q)
  );
  renderTable();
});

// ========================== ุงูุนุฑูุถ ==========================
async function loadOffers(){
  const res = await fetch(API_OFFERS);
  const data = await res.json();
  renderOffers(data);
}

function renderOffers(offers){
  const tbody = document.querySelector('#offersTable tbody');
  tbody.innerHTML = '';
  offers.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.id}</td>
      <td><input class="form-control form-control-sm" value="${o.title}" id="title${o.id}"></td>
      <td><input class="form-control form-control-sm" value="${o.desc}" id="desc${o.id}"></td>
      <td>
        <img src="${o.img||PLACEHOLDER_IMG}" class="prod-img mb-1">
        <input type="file" class="form-control form-control-sm" id="imgOffer${o.id}">
      </td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="updateOffer(${o.id})">ุชุนุฏูู</button>
        <button class="btn btn-sm btn-danger" onclick="deleteOffer(${o.id})">ุญุฐู</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ุนุฑูุถ
document.getElementById('addOfferForm').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch(API_ADMIN_OFFERS, {
    method:'POST',
    headers:{ 'Authorization':'Bearer '+TOKEN },
    body: fd
  });
  const json = await res.json();
  if(json.ok){ loadOffers(); e.target.reset(); }
};

async function updateOffer(id){
  const fd = new FormData();
  fd.append('title', document.getElementById(`title${id}`).value);
  fd.append('desc', document.getElementById(`desc${id}`).value);
  const imgFile = document.getElementById(`imgOffer${id}`).files[0];
  if(imgFile) fd.append('img', imgFile);
  const res = await fetch(`${API_ADMIN_OFFERS}/${id}`,{
    method:'PUT',
    headers:{ 'Authorization':'Bearer '+TOKEN },
    body: fd
  });
  const json = await res.json();
  if(json.ok) loadOffers();
}

async function deleteOffer(id){
  if(!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุนุฑุถุ')) return;
  const res = await fetch(`${API_ADMIN_OFFERS}/${id}`,{
    method:'DELETE',
    headers:{ 'Authorization':'Bearer '+TOKEN }
  });
  const json = await res.json();
  if(json.ok) loadOffers();
}

// ================= ุชุตุฏูุฑ ูุงุณุชูุฑุงุฏ JSON =================
document.getElementById('exportBtn').onclick = async () => {
  try {
    const res = await fetch(API_PUBLIC);
    const products = await res.json();
    const blob = new Blob([JSON.stringify(products, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "products.json";
    a.click();
    URL.revokeObjectURL(url);
  } catch(err) { alert("ูุดู ุงูุชุตุฏูุฑ"); console.error(err); }
};

document.getElementById('importBtn').onclick = async () => {
  const fileInput = document.getElementById('importFile');
  if(!fileInput.files[0]) return alert("ุงุฎุชุฑ ููู JSON ุฃููุงู");
  const file = fileInput.files[0];

  try {
    const text = await file.text();
    const products = JSON.parse(text);

    for(const p of products){
      const formData = new FormData();
      formData.append('name', p.name || '');
      formData.append('price', p.price || 0);
      formData.append('quantity', p.quantity || 0);
      formData.append('category', p.category || '');
      formData.append('barcode', p.barcode || '');
      formData.append('isWeightBased', p.isWeightBased || false);
      if(p.img) formData.append('img', p.img);

      await fetch(API_ADMIN, {
        method:'POST',
        headers:{ 'Authorization':'Bearer '+TOKEN },
        body: formData
      });
    }
    loadProducts();
    document.getElementById('importMsg').textContent = "ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ!";
    fileInput.value = '';
  } catch(err){
    alert("ูุดู ุงูุงุณุชูุฑุงุฏ"); console.error(err);
  }
};
</script>
</body>
</html>
